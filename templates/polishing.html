<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–®–ª–∏—Ñ–æ–≤–∫–∞ | –†–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ</title>
  <style>
    body {
      margin: 0;
      background: #f9f9f9;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      color: #333;
    }
    .top-bar {
      background: #fff;
      padding: 16px;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    table {
      width: 95%;
      margin: 20px auto;
      background: #fff;
      border-collapse: collapse;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    th, td {
      padding: 12px;
      border-bottom: 1px solid #eee;
      text-align: center;
      vertical-align: middle;
    }
    th {
      background-color: #f2f2f2;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 46px;
      height: 26px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      border-radius: 26px;
      transition: .3s ease-in-out;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      border-radius: 50%;
      transition: .3s ease-in-out;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    input:checked + .slider {
      background-color: #4CAF50;
      box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
    }
    input:checked + .slider:before {
      transform: translateX(20px);
    }
    .urgent-order {
      background-color: #ffe6e6 !important;
      border-left: 4px solid #ff4444;
    }
    .warning-order {
      background-color: #fff3cd !important;
      border-left: 4px solid #ffc107;
    }
    .completed {
      background-color: #f8f9fa !important;
      color: #6c757d;
      opacity: 0.7;
    }
    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .status-urgent { background-color: #ff4444; }
    .status-warning { background-color: #ffc107; }
    .status-normal { background-color: #6c757d; }
    .status-completed { background-color: #28a745; }
    .days-left {
      font-weight: bold;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 14px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      letter-spacing: 0.5px;
      min-width: 30px;
      display: inline-block;
      text-align: center;
    }
    .days-urgent { 
      background-color: #ff4444; 
      color: white; 
    }
    .days-warning { 
      background-color: #ffc107; 
      color: #333; 
    }
    .days-normal { 
      background-color: #6c757d; 
      color: white; 
    }
    .tabs { display: inline-flex; gap: 6px; margin-right: 16px; }
    .tab { padding: 8px 14px; border: 1px solid #ddd; border-bottom: 2px solid transparent; border-radius: 8px; background: #f7f7f7; color: #333; text-decoration: none; font-size: 14px; }
    .tab:hover { background: #f0f0f0; }
    .tab.active { background: #fff; border-color: #4CAF50; border-bottom-color: #4CAF50; color: #2c7a2c; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
  </style>
</head>
<body>
  <div class="top-bar">
    <h2>–®–ª–∏—Ñ–æ–≤–∫–∞ | –†–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ</h2>
    <div>
      <span class="tabs">
        <a class="tab active" href="{{ url_for('polishing_station') }}">ü™µ –®–ª–∏—Ñ–æ–≤–∫–∞</a>
        <a class="tab" href="{{ url_for('packaging_station') }}">üì¶ –£–ø–∞–∫–æ–≤–∫–∞</a>
      </span>
      {{ current_user.username }} ({{ current_user.role }}) | <a href="{{ url_for('logout') }}">–í—ã—Ö–æ–¥</a>
    </div>
  </div>

  <table id="polishing-table">
    <thead>
      <tr>
        <th>‚Ññ –ó–∞–∫–∞–∑–∞</th>
        <th>–ö–ª–∏–µ–Ω—Ç</th>
        <th>–î–Ω–µ–π –¥–æ —Å–¥–∞—á–∏</th>
        <th>–°—Ç–∞—Ç—É—Å</th>
        <th>–®–ª–∏—Ñ–æ–≤–∫–∞</th>
      </tr>
    </thead>
    <tbody>
      {% for o in orders %}
        {% if o.milling and o.facade_type != '—à–ø–æ–Ω' %}
          {% set days_left = order_urgency[o.id].days_left %}
          {% set is_urgent = order_urgency[o.id].is_urgent %}
          {% set row_class = "" %}
          {% if o.polishing_1 %}
            {% set row_class = "completed" %}
          {% elif is_urgent %}
            {% set row_class = "urgent-order" %}
          {% elif days_left <= 6 %}
            {% set row_class = "warning-order" %}
          {% endif %}
          
                     <tr data-order-id="{{ o.id }}" class="{{ row_class }}">
             <td>{{ o.order_id }}</td>
             <td>{{ o.client }}</td>
             <td>
               <span class="days-left {% if days_left <= 3 %}days-urgent{% elif days_left <= 6 %}days-warning{% else %}days-normal{% endif %}">
                 {{ days_left }}
               </span>
             </td>
             <td>
               {% if o.polishing_1 %}
                 <span class="status-indicator status-completed"></span>–ó–∞–≤–µ—Ä—à–µ–Ω
               {% elif is_urgent %}
                 <span class="status-indicator status-urgent"></span>–°—Ä–æ—á–Ω—ã–π
               {% elif days_left <= 6 %}
                 <span class="status-indicator status-warning"></span>–°–∫–æ—Ä–æ —Å—Ä–æ–∫
               {% else %}
                 <span class="status-indicator status-normal"></span>–û–∂–∏–¥–∞–µ—Ç
               {% endif %}
             </td>
             <td>
               <label class="switch">
                 <input type="checkbox" name="polishing" {% if o.polishing_1 %}checked{% endif %}>
                 <span class="slider"></span>
               </label>
             </td>
           </tr>
        {% endif %}
      {% endfor %}
    </tbody>
  </table>

  <script>
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
    function sortTableByPriority() {
      const tbody = document.querySelector('#polishing-table tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      
      rows.sort((a, b) => {
        const aCompleted = a.classList.contains('completed');
        const bCompleted = b.classList.contains('completed');
        
        // –°–Ω–∞—á–∞–ª–∞ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã
        if (aCompleted && !bCompleted) return 1;
        if (!aCompleted && bCompleted) return -1;
        
        // –ï—Å–ª–∏ –æ–±–∞ –∑–∞–≤–µ—Ä—à–µ–Ω—ã –∏–ª–∏ –æ–±–∞ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω—ã, —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏
        const aDays = parseInt(a.querySelector('.days-left').textContent);
        const bDays = parseInt(b.querySelector('.days-left').textContent);
        
        return aDays - bDays;
      });
      
      // –ü–µ—Ä–µ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏
      rows.forEach(row => tbody.appendChild(row));
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–ª–∞–π–¥–µ—Ä–æ–≤ —à–ª–∏—Ñ–æ–≤–∫–∏
    document.querySelectorAll('input[name="polishing"]').forEach(checkbox => {
      checkbox.addEventListener('change', async (e) => {
        const row = e.target.closest('tr');
        const orderId = row.getAttribute('data-order-id');
        const status = e.target.checked;

        try {
          const response = await fetch('/update_polishing', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ order_id: orderId, status: status })
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();
          
          if (result.success) {
            console.log(result.message);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã –≤ —Ç–∞–±–ª–∏—Ü–µ
            updateTableStatus(orderId, status);
            
            // –ü–µ—Ä–µ—Å–æ—Ä—Ç–∏—Ä–æ–≤—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
            sortTableByPriority();
            
          } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞: ' + (result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            e.target.checked = !status; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞:', error);
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞: ' + error.message);
          e.target.checked = !status; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        }
      });
    });

         function updateTableStatus(orderId, status) {
       const row = document.querySelector(`#polishing-table tr[data-order-id="${orderId}"]`);
       if (row) {
         if (status) {
           row.className = 'completed';
           const statusCell = row.querySelector('td:nth-child(4)');
           statusCell.innerHTML = '<span class="status-indicator status-completed"></span>–ó–∞–≤–µ—Ä—à–µ–Ω';
         } else {
           // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–ª–∞—Å—Å —Å—Ç—Ä–æ–∫–∏
           const daysLeft = parseInt(row.querySelector('.days-left').textContent);
           const isUrgent = daysLeft <= 3;
           const isWarning = daysLeft <= 6;
           
           if (isUrgent) {
             row.className = 'urgent-order';
           } else if (isWarning) {
             row.className = 'warning-order';
           } else {
             row.className = '';
           }
           
           const statusCell = row.querySelector('td:nth-child(4)');
           if (isUrgent) {
             statusCell.innerHTML = '<span class="status-indicator status-urgent"></span>–°—Ä–æ—á–Ω—ã–π';
           } else if (isWarning) {
             statusCell.innerHTML = '<span class="status-indicator status-warning"></span>–°–∫–æ—Ä–æ —Å—Ä–æ–∫';
           } else {
             statusCell.innerHTML = '<span class="status-indicator status-normal"></span>–û–∂–∏–¥–∞–µ—Ç';
           }
         }
       }
     }

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–∞–±–ª–∏—Ü—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', () => {
      sortTableByPriority();
    });
  </script>
</body>
</html>
