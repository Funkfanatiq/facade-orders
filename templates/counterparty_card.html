<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ö–∞—Ä—Ç–æ—á–∫–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞</title>
  <style>
    body { margin: 0; background: #f9f9f9; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; color: #333; }
    .top-bar {
      background: #fff;
      padding: 16px 20px;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .top-bar h1 { margin: 0; font-size: 22px; font-weight: 600; }
    .back-link { color: #1976D2; text-decoration: none; font-weight: 500; }
    .back-link:hover { text-decoration: underline; }
    .btn-invoice { padding: 10px 20px; background: #4CAF50; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 500; }
    .btn-invoice:hover { background: #45A049; }
    .invoice-modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 1000; justify-content: center; align-items: center; }
    .invoice-modal-overlay.show { display: flex; }
    .invoice-modal { background: #fff; border-radius: 12px; padding: 24px; max-width: 640px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
    .invoice-modal h3 { margin: 0 0 16px 0; font-size: 18px; }
    .invoice-add-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; align-items: flex-end; }
    .invoice-add-row input, .invoice-add-row select { padding: 8px 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; }
    .invoice-add-row input[type="number"] { width: 70px; }
    .invoice-add-row .name-input { flex: 1; min-width: 180px; }
    .invoice-add-row .unit-input { width: 70px; }
    .invoice-add-row .price-input { width: 90px; }
    .btn-add-item { padding: 8px 16px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
    .btn-add-item:hover { background: #45A049; }
    .invoice-items-table { width: 100%; border-collapse: collapse; margin: 16px 0; font-size: 14px; }
    .invoice-items-table th, .invoice-items-table td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
    .invoice-items-table th { background: #f5f5f5; font-weight: 600; }
    .btn-remove-item { background: #e0e0e0; color: #555; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .btn-remove-item:hover { background: #d0d0d0; }
    .btn-torg12 { display: inline-block; padding: 4px 10px; background: #2196F3; color: #fff; border-radius: 4px; font-size: 12px; text-decoration: none; margin-left: 6px; }
    .btn-torg12:hover { background: #1976D2; color: #fff; }
    .invoice-modal-actions { display: flex; gap: 12px; margin-top: 20px; }
    .invoice-modal-actions button { padding: 10px 24px; border-radius: 8px; font-size: 15px; cursor: pointer; border: none; }
    .btn-create-invoice { background: #4CAF50; color: #fff; }
    .btn-create-invoice:hover { background: #45A049; }
    .btn-cancel-invoice { background: #9e9e9e; color: #fff; }
    .btn-cancel-invoice:hover { background: #757575; }
    .invoice-empty-msg { color: #999; padding: 12px 0; font-size: 14px; }
    .invoices-list { margin-top: 12px; }
    .invoices-list a { color: #1976D2; text-decoration: none; }
    .invoices-list a:hover { text-decoration: underline; }
    .balance-block { display: flex; gap: 24px; flex-wrap: wrap; padding: 16px; background: #f5f5f5; border-radius: 8px; margin-bottom: 16px; }
    .balance-item { font-size: 15px; }
    .balance-item strong { color: #333; }
    .balance-item .label { color: #666; }
    .balance-owed { color: #d32f2f; font-weight: 600; }
    .balance-zero { color: #2e7d32; }
    .balance-over { color: #1976d2; }
    .btn-payment { padding: 8px 16px; background: #4CAF50; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
    .btn-payment:hover { background: #45A049; }
    .payment-modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 1000; justify-content: center; align-items: center; }
    .payment-modal-overlay.show { display: flex; }
    .payment-modal { background: #fff; border-radius: 12px; padding: 24px; max-width: 420px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
    .payment-modal h3 { margin: 0 0 16px 0; }
    .payment-modal input, .payment-modal select { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 6px; }
    .invoices-table { width: 100%; border-collapse: collapse; font-size: 14px; }
    .invoices-table th, .invoices-table td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
    .invoices-table th { background: #f5f5f5; font-weight: 600; }
    .invoices-table .amount { white-space: nowrap; }
    .container { max-width: 900px; margin: 0 auto; padding: 20px; }
    .card-block {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      border: 1px solid #eee;
    }
    .card-block h3 { margin: 0 0 16px 0; font-size: 18px; color: #555; border-bottom: 1px solid #eee; padding-bottom: 8px; }
    .card-block dl { margin: 0; display: grid; grid-template-columns: 180px 1fr; gap: 8px 20px; }
    .card-block dt { margin: 0; color: #666; font-weight: 500; }
    .card-block dd { margin: 0; }
    table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.06); }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
    th { background: #f5f5f5; font-weight: 600; color: #555; font-size: 14px; }
    .row-green { background-color: #f1f8e9; }
    .row-warning { background-color: #fff8e1; }
    .row-danger { background-color: #ffebee; }
    .empty-orders { color: #666; padding: 20px; text-align: center; background: #fff; border-radius: 8px; border: 1px dashed #ddd; }
    .cp-tabs { display: flex; background: #fff; border-radius: 8px; padding: 4px; gap: 4px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    .cp-tab { padding: 10px 20px; cursor: pointer; border-radius: 6px; font-weight: 500; border: none; background: #f2f2f2; color: #555; font-size: 15px; }
    .cp-tab:hover { background: #e8e8e8; color: #333; }
    .cp-tab.active { background: #757575; color: #fff; }
    .cp-tab-content { display: none; }
    .cp-tab-content.active { display: block; }
    .cp-buttons-row { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }
  </style>
</head>
<body>
  <div class="top-bar">
    <h1>üë§ {{ counterparty.name }}</h1>
    <div style="display:flex; gap:12px; align-items:center;">
      {% if current_user.role in ["–ú–µ–Ω–µ–¥–∂–µ—Ä", "–ê–¥–º–∏–Ω"] %}
      <button type="button" class="btn-payment" onclick="openEditModal()">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
      {% endif %}
      <a href="{{ url_for('dashboard') }}" class="back-link">‚Üê –ù–∞–∑–∞–¥ –∫ –ø–∞–Ω–µ–ª–∏ –∑–∞–∫–∞–∑–æ–≤</a>
    </div>
  </div>

  {% if current_user.role in ["–ú–µ–Ω–µ–¥–∂–µ—Ä", "–ê–¥–º–∏–Ω"] %}
  <div id="edit-modal-overlay" class="payment-modal-overlay">
    <div class="payment-modal" style="max-width:520px;">
      <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞</h3>
      <form method="POST" action="{{ url_for('counterparty_edit', counterparty_id=counterparty.id) }}" class="counterparty-form" style="margin:0;">
        <div class="counterparty-block" style="margin-bottom:12px;">
          <input type="text" name="counterparty_name" value="{{ counterparty.name }}" placeholder="–ò–º—è" required style="width:100%; padding:10px; margin:4px 0;">
          <input type="text" name="counterparty_phone" value="{{ counterparty.phone or '' }}" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" style="width:100%; padding:10px; margin:4px 0;">
          <input type="text" name="counterparty_email" value="{{ counterparty.email or '' }}" placeholder="–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –∞–¥—Ä–µ—Å" style="width:100%; padding:10px; margin:4px 0;">
        </div>
        <div class="counterparty-block" style="margin-bottom:12px;">
          <select name="counterparty_type" style="width:100%; padding:10px; margin:4px 0;">
            <option value="">‚Äî –¢–∏–ø ‚Äî</option>
            <option value="—é—Ä –ª–∏—Ü–æ" {{ 'selected' if counterparty.counterparty_type == '—é—Ä –ª–∏—Ü–æ' else '' }}>–Æ—Ä. –ª–∏—Ü–æ</option>
            <option value="—Ñ–∏–∑ –ª–∏—Ü–æ" {{ 'selected' if counterparty.counterparty_type == '—Ñ–∏–∑ –ª–∏—Ü–æ' else '' }}>–§–∏–∑. –ª–∏—Ü–æ</option>
          </select>
          <input type="text" name="counterparty_inn" value="{{ counterparty.inn or '' }}" placeholder="–ò–ù–ù" style="width:100%; padding:10px; margin:4px 0;">
          <input type="text" name="counterparty_full_name" value="{{ counterparty.full_name or '' }}" placeholder="–ü–æ–ª–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ" style="width:100%; padding:10px; margin:4px 0;">
          <input type="text" name="counterparty_legal_address" value="{{ counterparty.legal_address or '' }}" placeholder="–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å" style="width:100%; padding:10px; margin:4px 0;">
          <input type="text" name="counterparty_fias_code" value="{{ counterparty.fias_code or '' }}" placeholder="–ö–æ–¥ –§–ò–ê–°" style="width:100%; padding:10px; margin:4px 0;">
          <input type="text" name="counterparty_kpp" value="{{ counterparty.kpp or '' }}" placeholder="–ö–ü–ü" style="width:100%; padding:10px; margin:4px 0;">
          <input type="text" name="counterparty_ogrn" value="{{ counterparty.ogrn or '' }}" placeholder="–û–ì–†–ù" style="width:100%; padding:10px; margin:4px 0;">
          <input type="text" name="counterparty_okpo" value="{{ counterparty.okpo or '' }}" placeholder="–û–ö–ü–û" style="width:100%; padding:10px; margin:4px 0;">
          <input type="text" name="counterparty_bik" value="{{ counterparty.bik or '' }}" placeholder="–ë–ò–ö" style="width:100%; padding:10px; margin:4px 0;">
          <input type="text" name="counterparty_bank" value="{{ counterparty.bank or '' }}" placeholder="–ë–∞–Ω–∫" style="width:100%; padding:10px; margin:4px 0;">
          <input type="text" name="counterparty_address" value="{{ counterparty.address or '' }}" placeholder="–ê–¥—Ä–µ—Å" style="width:100%; padding:10px; margin:4px 0;">
          <input type="text" name="counterparty_corr_account" value="{{ counterparty.corr_account or '' }}" placeholder="–ö–æ—Ä—Ä. —Å—á—ë—Ç" style="width:100%; padding:10px; margin:4px 0;">
          <input type="text" name="counterparty_payment_account" value="{{ counterparty.payment_account or '' }}" placeholder="–†–∞—Å—á—ë—Ç–Ω—ã–π —Å—á—ë—Ç" style="width:100%; padding:10px; margin:4px 0;">
        </div>
        <div style="display:flex; gap:10px; margin-top:16px;">
          <button type="submit" class="btn-create-invoice">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button type="button" class="btn-cancel-invoice" onclick="closeEditModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </form>
    </div>
  </div>
  {% endif %}

  <div id="invoice-modal-overlay" class="invoice-modal-overlay">
    <div class="invoice-modal">
      <h3>–°–æ–∑–¥–∞—Ç—å —Å—á—ë—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É</h3>
      <p style="margin:0 0 8px 0; color:#666; font-size:14px;">–ù–æ–º–µ—Ä —Å—á—ë—Ç–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</p>
      <input type="text" id="invoice-number" placeholder="–ù–∞–ø—Ä. 00044" style="width:120px; margin-bottom:12px; padding:8px;" required>
      <p style="margin:0 0 12px 0; color:#666; font-size:14px;">–î–æ–±–∞–≤—å—Ç–µ –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ –ø—Ä–∞–π—Å–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –≤—Ä—É—á–Ω—É—é:</p>
      <div class="invoice-add-row">
        <select id="invoice-pricelist-select" style="min-width:260px;">
          <option value="">‚Äî –í—ã–±—Ä–∞—Ç—å –∏–∑ –ø—Ä–∞–π—Å–∞ ‚Äî</option>
          {% set grid_cats = [('–ø–ª–æ—Å–∫–∏–π', '–ü–ª–æ—Å–∫–∏–µ'), ('—Ñ—Ä–µ–∑–µ—Ä–æ–≤–∞–Ω–Ω—ã–π', '–§—Ä–µ–∑–µ—Ä–æ–≤–∞–Ω–Ω—ã–µ'), ('—à–ø–æ–Ω', '–®–ø–æ–Ω'), ('—É—Å–ª—É–≥–∏ –ø–æ –ø–æ–∫—Ä–∞—Å–∫–µ', '–£—Å–ª—É–≥–∏ –ø–æ –ø–æ–∫—Ä–∞—Å–∫–µ'), ('–î–æ–ø —É—Å–ª—É–≥–∏', '–î–æ–ø —É—Å–ª—É–≥–∏')] %}
          {% for cat, label in grid_cats %}
          {% set cat_items = price_list|selectattr('category', 'equalto', cat)|list %}
          {% if cat_items %}
          <optgroup label="{{ label }}">
            {% for p in cat_items %}
            <option value="{{ p.id }}" data-name="{{ p.name|e }}" data-price="{{ p.price }}" data-unit="{{ p.unit or '—à—Ç' }}">{{ p.name }} ‚Äî {{ (p.price|round(2))|string|replace(".", ",") }} ‚ÇΩ/{{ p.unit or '—à—Ç' }}</option>
            {% endfor %}
          </optgroup>
          {% endif %}
          {% endfor %}
        </select>
        <input type="number" id="invoice-qty-pricelist" placeholder="–ö–æ–ª-–≤–æ" step="0.01" min="0.01" value="1" style="width:70px;">
        <button type="button" class="btn-add-item" onclick="addFromPricelist()">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
      <div class="invoice-add-row" style="border-top:1px solid #eee; padding-top:12px; margin-top:8px;">
        <input type="text" id="invoice-manual-name" class="name-input" placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ (–≤—Ä—É—á–Ω—É—é)">
        <input type="text" id="invoice-manual-unit" class="unit-input" placeholder="–ï–¥." value="–º¬≤">
        <input type="number" id="invoice-manual-qty" placeholder="–ö–æ–ª-–≤–æ" step="0.01" min="0.01" value="1" style="width:70px;">
        <input type="number" id="invoice-manual-price" class="price-input" placeholder="–¶–µ–Ω–∞" step="0.01" min="0">
        <button type="button" class="btn-add-item" onclick="addManualItem()">–î–æ–±–∞–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é</button>
      </div>
      <table class="invoice-items-table" id="invoice-items-table">
        <thead><tr><th>‚Ññ</th><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th><th>–ï–¥.</th><th>–ö–æ–ª-–≤–æ</th><th>–¶–µ–Ω–∞, ‚ÇΩ</th><th>–°—É–º–º–∞, ‚ÇΩ</th><th></th></tr></thead>
        <tbody id="invoice-items-tbody"></tbody>
      </table>
      <p class="invoice-empty-msg" id="invoice-empty-msg">–ü–æ–∑–∏—Ü–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p>
      <div class="invoice-modal-actions">
        <button type="button" class="btn-create-invoice" onclick="createInvoice()">–°–æ–∑–¥–∞—Ç—å —Å—á—ë—Ç</button>
        <button type="button" class="btn-cancel-invoice" onclick="closeInvoiceModal()">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>

  <div id="payment-modal-overlay" class="payment-modal-overlay">
    <div class="payment-modal">
      <h3>–í–Ω–µ—Å—Ç–∏ –æ–ø–ª–∞—Ç—É</h3>
      <label>–°—É–º–º–∞, ‚ÇΩ</label>
      <input type="number" id="payment-amount" step="0.01" min="0.01" placeholder="–°—É–º–º–∞">
      <label>–î–∞—Ç–∞</label>
      <input type="date" id="payment-date">
      <label>–ö —Å—á—ë—Ç—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
      <select id="payment-invoice">
        <option value="">‚Äî –û–±—â–∞—è –æ–ø–ª–∞—Ç–∞ ‚Äî</option>
        {% for inv in invoices %}
        <option value="{{ inv.id }}">–°—á—ë—Ç ‚Ññ {{ inv.invoice_number }} ‚Äî {{ "%.2f"|format(inv.total)|replace(".", ",") }} ‚ÇΩ</option>
        {% endfor %}
      </select>
      <label>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label>
      <input type="text" id="payment-note" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ">
      <div style="display:flex; gap:10px; margin-top:16px;">
        <button type="button" class="btn-create-invoice" onclick="createPayment()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button type="button" class="btn-cancel-invoice" onclick="closePaymentModal()">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="cp-tabs">
      <button type="button" class="cp-tab active" onclick="showCpTab('card', this)">–ö–∞—Ä—Ç–æ—á–∫–∞</button>
      <button type="button" class="cp-tab" onclick="showCpTab('orders', this)">–¢–µ–∫—É—â–∏–µ –∑–∞–∫–∞–∑—ã</button>
      <button type="button" class="cp-tab" onclick="showCpTab('invoices', this)">–°—á–µ—Ç–∞ –∏ –æ–ø–ª–∞—Ç—ã</button>
    </div>

    <div id="cp-tab-card" class="cp-tab-content active">
    <div class="card-block">
      <h3>–û –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–µ</h3>
      <dl>
        <dt>–ò–º—è</dt><dd>{{ counterparty.name }}</dd>
        <dt>–¢–µ–ª–µ—Ñ–æ–Ω</dt><dd>{{ counterparty.phone or '‚Äî' }}</dd>
        <dt>–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –∞–¥—Ä–µ—Å</dt><dd>{{ counterparty.email or '‚Äî' }}</dd>
      </dl>
    </div>

    <div class="card-block">
      <h3>–†–µ–∫–≤–∏–∑–∏—Ç—ã</h3>
      <dl>
        <dt>–¢–∏–ø –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞</dt><dd>{{ counterparty.counterparty_type or '‚Äî' }}</dd>
        <dt>–ò–ù–ù</dt><dd>{{ counterparty.inn or '‚Äî' }}</dd>
        <dt>–ü–æ–ª–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</dt><dd>{{ counterparty.full_name or '‚Äî' }}</dd>
        <dt>–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å</dt><dd>{{ counterparty.legal_address or '‚Äî' }}</dd>
        <dt>–ö–æ–¥ –§–ò–ê–°</dt><dd>{{ counterparty.fias_code or '‚Äî' }}</dd>
        <dt>–ö–ü–ü</dt><dd>{{ counterparty.kpp or '‚Äî' }}</dd>
        <dt>–û–ì–†–ù</dt><dd>{{ counterparty.ogrn or '‚Äî' }}</dd>
        <dt>–û–ö–ü–û</dt><dd>{{ counterparty.okpo or '‚Äî' }}</dd>
        <dt>–ë–ò–ö</dt><dd>{{ counterparty.bik or '‚Äî' }}</dd>
        <dt>–ë–∞–Ω–∫</dt><dd>{{ counterparty.bank or '‚Äî' }}</dd>
        <dt>–ê–¥—Ä–µ—Å</dt><dd>{{ counterparty.address or '‚Äî' }}</dd>
        <dt>–ö–æ—Ä—Ä. —Å—á—ë—Ç</dt><dd>{{ counterparty.corr_account or '‚Äî' }}</dd>
        <dt>–†–∞—Å—á—ë—Ç–Ω—ã–π —Å—á—ë—Ç</dt><dd>{{ counterparty.payment_account or '‚Äî' }}</dd>
      </dl>
    </div>
    </div>

    <div id="cp-tab-orders" class="cp-tab-content">
    <div class="card-block">
      <h3>–¢–µ–∫—É—â–∏–µ –∑–∞–∫–∞–∑—ã</h3>
      {% if orders %}
      <table>
        <thead>
          <tr>
            <th>‚Ññ –∑–∞–∫–∞–∑–∞</th>
            <th>–ö–ª–∏–µ–Ω—Ç</th>
            <th>–°—Ä–æ–∫</th>
            <th>–§—Ä–µ–∑–µ—Ä–æ–≤–∫–∞</th>
            <th>–®–ª–∏—Ñ–æ–≤–∫–∞</th>
            <th>–£–ø–∞–∫–æ–≤–∫–∞</th>
            <th>–û—Ç–≥—Ä—É–∑–∫–∞</th>
            <th>–û–ø–ª–∞—Ç–∞</th>
            <th>–§–∞–π–ª—ã</th>
          </tr>
        </thead>
        <tbody>
          {% for o in orders %}
            {% set days_left = (o.due_date - datetime.utcnow().date()).days %}
            {% set row_class = "" %}
            {% if o.packaging %} {% set row_class = "row-green" %}
            {% elif days_left <= 3 %} {% set row_class = "row-danger" %}
            {% elif days_left <= 6 %} {% set row_class = "row-warning" %}
            {% endif %}
            <tr class="{{ row_class }}">
              <td>{{ o.order_id }}</td>
              <td>{{ o.client }}</td>
              <td>{{ o.due_date.strftime('%Y-%m-%d') }}</td>
              <td>{{ "‚úî" if o.milling else "‚Äî" }}</td>
              <td>{{ "‚úî" if o.polishing_1 else "‚Äî" }}</td>
              <td>{{ "‚úî" if o.packaging else "‚Äî" }}</td>
              <td>{{ "‚úî" if o.shipment else "‚Äî" }}</td>
              <td>{{ "‚úî" if o.paid else "‚Äî" }}</td>
              <td>
                {% if o.filenames %}
                  {% for fn in o.filenames.split(';') %}
                    {% if fn %}
                      <a href="{{ url_for('uploaded_file', filename=fn) }}" target="_blank">üìé {{ fn }}</a><br>
                    {% endif %}
                  {% endfor %}
                {% else %}‚Äî
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="empty-orders">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤ –ø–æ —ç—Ç–æ–º—É –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—É.</p>
      {% endif %}
    </div>
    </div>

    <div id="cp-tab-invoices" class="cp-tab-content">
    <div class="card-block">
    <div class="cp-buttons-row">
      <button type="button" class="btn-invoice" onclick="openInvoiceModal()">üìÑ –í—ã—Å—Ç–∞–≤–∏—Ç—å —Å—á—ë—Ç</button>
      <button type="button" class="btn-payment" onclick="openPaymentModal()">üí∞ –í–Ω–µ—Å—Ç–∏ –æ–ø–ª–∞—Ç—É</button>
    </div>
      <h3>–ë–∞–ª–∞–Ω—Å –∏ —Ä–∞—Å—á—ë—Ç—ã</h3>
      <div class="balance-block">
        <div class="balance-item"><span class="label">–í—ã—Å—Ç–∞–≤–ª–µ–Ω–æ (—Å—á–µ—Ç–∞):</span> <strong>{{ "%.2f"|format(total_invoiced)|replace(".", ",") }} ‚ÇΩ</strong></div>
        <div class="balance-item"><span class="label">–û–ø–ª–∞—á–µ–Ω–æ:</span> <strong>{{ "%.2f"|format(total_paid)|replace(".", ",") }} ‚ÇΩ</strong></div>
        <div class="balance-item"><span class="label">–û—Å—Ç–∞—Ç–æ–∫ –∫ –æ–ø–ª–∞—Ç–µ:</span> <strong class="{% if balance > 0 %}balance-owed{% elif balance < 0 %}balance-over{% else %}balance-zero{% endif %}">{{ "%.2f"|format(balance)|replace(".", ",") }} ‚ÇΩ</strong></div>
      </div>
      <h3>–°—á–µ—Ç–∞</h3>
      {% if invoices %}
      <table class="invoices-table">
        <thead><tr><th>‚Ññ —Å—á—ë—Ç–∞</th><th>–î–∞—Ç–∞</th><th>–ó–∞–∫–∞–∑—ã</th><th>–°—É–º–º–∞</th><th>–û–ø–ª–∞—á–µ–Ω–æ</th><th>–û—Å—Ç–∞—Ç–æ–∫</th><th></th></tr></thead>
        <tbody>
        {% for inv in invoices %}
        <tr>
          <td><a href="{{ url_for('invoice_pdf', invoice_id=inv.id) }}" download="invoice_{{ inv.invoice_number }}.pdf">‚Ññ {{ inv.invoice_number }}</a></td>
          <td>{{ inv.invoice_date.strftime('%d.%m.%Y') }}</td>
          <td>{{ inv.order_ids or '‚Äî' }}</td>
          <td class="amount">{{ "%.2f"|format(inv.total)|replace(".", ",") }} ‚ÇΩ</td>
          <td class="amount">{{ "%.2f"|format(inv.paid_amount)|replace(".", ",") }} ‚ÇΩ</td>
          <td class="amount {% if inv.balance > 0 %}balance-owed{% elif inv.balance < 0 %}balance-over{% else %}balance-zero{% endif %}">{{ "%.2f"|format(inv.balance)|replace(".", ",") }} ‚ÇΩ</td>
          <td>
            <a href="{{ url_for('invoice_pdf', invoice_id=inv.id) }}" download="invoice_{{ inv.invoice_number }}.pdf">PDF</a>
            <a href="{{ url_for('invoice_torg12', invoice_id=inv.id) }}" class="btn-torg12">–¢–û–†–ì-12</a>
            <a href="{{ url_for('invoice_torg12_xlsx', invoice_id=inv.id) }}">Excel</a>
            {% if current_user.role in ["–ú–µ–Ω–µ–¥–∂–µ—Ä", "–ê–¥–º–∏–Ω"] %}
            <button type="button" class="btn-remove-item" onclick="deleteInvoice({{ inv.id }})" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="invoice-empty-msg">–°—á—ë—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>
      {% endif %}
      {% if payments %}
      <h3 style="margin-top:20px;">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–ª–∞—Ç</h3>
      <table class="invoices-table">
        <thead><tr><th>–î–∞—Ç–∞</th><th>–°—É–º–º–∞</th><th>–ö —Å—á—ë—Ç—É</th><th>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th><th></th></tr></thead>
        <tbody>
        {% for p in payments %}
        <tr>
          <td>{{ p.payment_date.strftime('%d.%m.%Y') }}</td>
          <td class="amount">{{ "%.2f"|format(p.amount)|replace(".", ",") }} ‚ÇΩ</td>
          <td>{% if p.invoice %}‚Ññ {{ p.invoice.invoice_number }}{% else %}‚Äî{% endif %}</td>
          <td>{{ p.note or '‚Äî' }}</td>
          <td>{% if current_user.role in ["–ú–µ–Ω–µ–¥–∂–µ—Ä", "–ê–¥–º–∏–Ω"] %}<button type="button" class="btn-remove-item" onclick="deletePayment({{ p.id }})" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>{% endif %}</td>
        </tr>
        {% endfor %}
        </tbody>
      </table>
      {% endif %}
    </div>
    </div>
  </div>

  <script>
    var invoiceItems = [];
    var counterpartyId = {{ counterparty.id }};

    (function initTab() {
      var params = new URLSearchParams(window.location.search);
      var tab = params.get('tab');
      if (tab === 'invoices') {
        var btn = document.querySelector('.cp-tab[onclick*="invoices"]');
        if (btn) showCpTab('invoices', btn);
      } else if (tab === 'orders') {
        var btn = document.querySelector('.cp-tab[onclick*="orders"]');
        if (btn) showCpTab('orders', btn);
      }
    })();

    function showCpTab(tabName, btn) {
      document.querySelectorAll('.cp-tab-content').forEach(function(el) { el.classList.remove('active'); });
      document.querySelectorAll('.cp-tab').forEach(function(el) { el.classList.remove('active'); });
      var content = document.getElementById('cp-tab-' + tabName);
      if (content) content.classList.add('active');
      if (btn) btn.classList.add('active');
    }
    function openEditModal() {
      document.getElementById('edit-modal-overlay').classList.add('show');
    }
    function closeEditModal() {
      document.getElementById('edit-modal-overlay').classList.remove('show');
    }
    function deleteInvoice(id) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å—á—ë—Ç? –û–ø–ª–∞—Ç—ã, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∫ –Ω–µ–º—É, —Å—Ç–∞–Ω—É—Ç –æ–±—â–∏–º–∏.')) return;
      fetch('/invoice/' + id + '/delete', { method: 'POST' }).then(function(r) { return r.json(); }).then(function(data) {
        if (data.ok) window.location.reload();
        else alert(data.error || '–û—à–∏–±–∫–∞');
      }).catch(function() { alert('–û—à–∏–±–∫–∞'); });
    }
    function deletePayment(id) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –æ–ø–ª–∞—Ç—É?')) return;
      fetch('/payment/' + id + '/delete', { method: 'POST' }).then(function(r) { return r.json(); }).then(function(data) {
        if (data.ok) window.location.reload();
        else alert(data.error || '–û—à–∏–±–∫–∞');
      }).catch(function() { alert('–û—à–∏–±–∫–∞'); });
    }

    function openInvoiceModal() {
      invoiceItems = [];
      document.getElementById('invoice-number').value = '';
      renderInvoiceItems();
      document.getElementById('invoice-modal-overlay').classList.add('show');
    }
    function closeInvoiceModal() {
      document.getElementById('invoice-modal-overlay').classList.remove('show');
    }
    function addFromPricelist() {
      var sel = document.getElementById('invoice-pricelist-select');
      var opt = sel.options[sel.selectedIndex];
      if (!opt || !opt.value) return;
      var qty = parseFloat(document.getElementById('invoice-qty-pricelist').value) || 1;
      var name = opt.getAttribute('data-name');
      var price = parseFloat(opt.getAttribute('data-price')) || 0;
      var unit = opt.getAttribute('data-unit') || '—à—Ç';
      invoiceItems.push({ name: name, unit: unit, quantity: qty, price: price, price_list_item_id: parseInt(opt.value, 10) });
      renderInvoiceItems();
    }
    function addManualItem() {
      var name = document.getElementById('invoice-manual-name').value.trim();
      if (!name) return;
      var unit = document.getElementById('invoice-manual-unit').value.trim() || '–º¬≤';
      var qty = parseFloat(document.getElementById('invoice-manual-qty').value) || 1;
      var price = parseFloat(document.getElementById('invoice-manual-price').value) || 0;
      invoiceItems.push({ name: name, unit: unit, quantity: qty, price: price, price_list_item_id: null });
      renderInvoiceItems();
      document.getElementById('invoice-manual-name').value = '';
      document.getElementById('invoice-manual-price').value = '';
    }
    function removeInvoiceItem(idx) {
      invoiceItems.splice(idx, 1);
      renderInvoiceItems();
    }
    function renderInvoiceItems() {
      var tbody = document.getElementById('invoice-items-tbody');
      var empty = document.getElementById('invoice-empty-msg');
      tbody.innerHTML = '';
      if (invoiceItems.length === 0) {
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';
      invoiceItems.forEach(function(it, i) {
        var sum = (it.quantity * it.price).toFixed(2).replace('.', ',');
        var priceStr = (it.price || 0).toFixed(2).replace('.', ',');
        var qtyStr = (it.quantity || 0).toString().replace('.', ',');
        var tr = document.createElement('tr');
        tr.innerHTML = '<td>' + (i + 1) + '</td><td>' + (it.name || '') + '</td><td>' + (it.unit || '—à—Ç') + '</td><td>' + qtyStr + '</td><td>' + priceStr + '</td><td>' + sum + '</td><td><button type="button" class="btn-remove-item" onclick="removeInvoiceItem(' + i + ')">–£–¥–∞–ª–∏—Ç—å</button></td>';
        tbody.appendChild(tr);
      });
    }
    function createInvoice() {
      var invoiceNum = document.getElementById('invoice-number').value.trim();
      if (!invoiceNum) {
        alert('–£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä —Å—á—ë—Ç–∞');
        return;
      }
      if (invoiceItems.length === 0) {
        alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –ø–æ–∑–∏—Ü–∏—é');
        return;
      }
      fetch('/counterparty/' + counterpartyId + '/invoice/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items: invoiceItems, invoice_number: invoiceNum })
      }).then(function(r) {
        return r.json();
      }).then(function(data) {
        if (data.ok) {
          closeInvoiceModal();
          window.location.href = window.location.pathname + '?tab=invoices';
        } else {
          alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á—ë—Ç–∞');
        }
      }).catch(function() {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á—ë—Ç–∞');
      });
    }

    function openPaymentModal() {
      document.getElementById('payment-amount').value = '';
      document.getElementById('payment-date').value = new Date().toISOString().slice(0, 10);
      document.getElementById('payment-modal-overlay').classList.add('show');
    }
    function closePaymentModal() {
      document.getElementById('payment-modal-overlay').classList.remove('show');
    }
    function createPayment() {
      var amount = parseFloat(document.getElementById('payment-amount').value);
      if (!amount || amount <= 0) {
        alert('–£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É');
        return;
      }
      var paymentDate = document.getElementById('payment-date').value;
      var invoiceId = document.getElementById('payment-invoice').value;
      var note = document.getElementById('payment-note').value;
      var body = { amount: amount, payment_date: paymentDate, note: note };
      if (invoiceId) body.invoice_id = parseInt(invoiceId, 10);
      fetch('/counterparty/' + counterpartyId + '/payment/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      }).then(function(r) { return r.json(); }).then(function(data) {
        if (data.ok) {
          closePaymentModal();
          window.location.reload();
        } else {
          alert(data.error || '–û—à–∏–±–∫–∞');
        }
      }).catch(function() { alert('–û—à–∏–±–∫–∞'); });
    }
  </script>
</body>
</html>
