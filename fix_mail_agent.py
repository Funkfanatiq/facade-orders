#!/usr/bin/env python3
"""
–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—á—Ç–æ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
"""

import os
import sys

# –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤ –ø—É—Ç—å
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from app import app, db
from models import Email

def fix_mail_agent():
    """–ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–æ—á—Ç–æ–≤—ã–º –∞–≥–µ–Ω—Ç–æ–º"""
    with app.app_context():
        try:
            print("üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—á—Ç–æ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç–∞...")
            print("=" * 50)
            
            # 1. –û—á–∏—â–∞–µ–º –≤—Å–µ –ø–∏—Å—å–º–∞
            print("1Ô∏è‚É£ –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –ø–∏—Å–µ–º...")
            Email.query.delete()
            db.session.commit()
            print("‚úÖ –í—Å–µ –ø–∏—Å—å–º–∞ —É–¥–∞–ª–µ–Ω—ã")
            
            # 2. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã
            print("\n2Ô∏è‚É£ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü—ã...")
            try:
                # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                db.engine.execute("DROP INDEX IF EXISTS email_message_id_key")
                print("‚úÖ –£–¥–∞–ª–µ–Ω —Å—Ç–∞—Ä—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å")
            except Exception as e:
                print(f"‚ÑπÔ∏è –°—Ç–∞—Ä—ã–π –∏–Ω–¥–µ–∫—Å –Ω–µ –Ω–∞–π–¥–µ–Ω: {e}")
            
            try:
                # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ã—á–Ω—ã–π –∏–Ω–¥–µ–∫—Å
                db.engine.execute("CREATE INDEX IF NOT EXISTS idx_email_message_id ON email (message_id)")
                print("‚úÖ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å")
            except Exception as e:
                print(f"‚ÑπÔ∏è –ò–Ω–¥–µ–∫—Å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: {e}")
            
            print("\n‚úÖ –ü–æ—á—Ç–æ–≤—ã–π –∞–≥–µ–Ω—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω!")
            print("üìß –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–Ω–æ–≤–æ –ø–æ–ª—É—á–∞—Ç—å –ø–∏—Å—å–º–∞")
            print("üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ")
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
            db.session.rollback()

if __name__ == "__main__":
    fix_mail_agent()
