# Полная спецификация ТОРГ-12 из Excel (образец 11 от 12.07.2016)
# Извлечено из TORG-12-Tovarnaya-nakladnaya-11-ot-12-iyulya-2016-g-obrazets.xlsx

import re

# === ШИРИНЫ КОЛОНОК (Excel units, 1 unit ≈ 0.852 mm) ===
COL_WIDTHS_EXCEL = [
    1.1640625, 5.83203125, 12.6640625, 2.33203125, 18.6640625, 2, 12.1640625,
    5.1640625, 2.1640625, 1.6640625, 0.5, 7.5, 7.83203125, 0.6640625, 5.1640625,
    1.33203125, 9.33203125, 0.6640625, 2.6640625, 2.6640625, 2.33203125, 7,
    3.5, 3.5, 10, 5.33203125, 1.83203125, 4.6640625, 0.6640625, 2.5,
    0.33203125, 7.1640625, 2, 0.83203125, 3.5, 3, 7, 1.1640625, 13,
    0.6640625, 0.5
]

# === ВЫСОТЫ СТРОК (в pt, 1 pt = 1/72 inch) ===
ROW_HEIGHTS_PT = {
    1: 15.95, 2: 12.95, 3: 12, 4: 12, 5: 8.1, 6: 12, 7: 14.1, 8: 21.95,
    9: 8.1, 10: 21.95, 11: 8.1, 12: 21.95, 13: 8.1, 14: 12, 15: 12, 16: 12,
    17: 12, 18: 12, 19: 11.1, 20: 11.1, 21: 44.1, 22: 11.1, 23: 11.1, 24: 11.1,
    25: 11.1, 26: 11.1, 27: 11.1, 28: 12, 29: 11.1, 30: 8.1, 31: 11.1, 32: 8.1,
    33: 11.1, 34: 8.1, 35: 5.1, 36: 9.95, 37: 11.1, 38: 9.95, 39: 11.1,
    40: 11.1, 41: 21.95, 42: 9, 43: 11.1, 44: 11.1, 45: 11.1, 46: 11.1,
    47: 5.1, 48: 11.1,
}
DEFAULT_ROW_HEIGHT_PT = 11.45

# === ОБЪЕДИНЁННЫЕ ЯЧЕЙКИ (как в Excel) ===
MERGED_CELLS = [
    "A1:AM1", "B3:AC4", "AM5:AM6", "B6:AI6", "B8:C8", "D8:AI8",
    "AM9:AM10", "D10:AI10", "AM11:AM12", "D12:AI12",
    "AK13:AL14", "AM13:AM14", "D14:AI14", "AK15:AL15",
    "K16:N16", "O16:R16", "AK16:AL16", "K17:N17", "O17:R17", "AK17:AL17",
    "B20:B21", "C20:G20", "H20:L20", "M20:M21", "N20:Q20", "R20:U21",
    "V20:W21", "X20:Y21", "Z20:AD21", "AE20:AK20", "AL20:AO21",
    "B20:B21", "C21:F21", "H21:K21", "N21:P21", "AE21:AH21", "AI21:AK21",
    "C22:F22", "H22:K22", "N22:P22", "R22:U22", "V22:W22", "X22:Y22",
    "Z22:AD22", "AE22:AH22", "AI22:AK22", "AL22:AO22",
    "C23:F23", "H23:K23", "V23:W23", "X23:Y23", "Z23:AD23",
    "AE23:AH23", "AI23:AK23", "AL23:AO23",
    "C24:F24", "H24:K24", "V24:W24", "X24:Y24", "Z24:AD24",
    "AE24:AH24", "AI24:AK24", "AL24:AO24",
    "C25:F25", "H25:K25", "V25:W25", "X25:Y25", "Z25:AD25",
    "AE25:AH25", "AI25:AK25", "AL25:AO25",
    "V26:W26", "X26:Y26", "Z26:AD26", "AE26:AH26", "AI26:AK26", "AL26:AO26",
    "V27:W27", "X27:Y27", "Z27:AD27", "AE27:AH27", "AI27:AK27", "AL27:AO27",
    "F31:H33", "AB31:AF31", "AB32:AF32", "AH32:AN33", "AB33:AF33",
    "F34:H34", "AB34:AF34", "G37:I37", "B39:S39", "B40:O40",
    "J41:S41", "J42:S42", "J43:S43", "AB43:AF43",
    "J44:S44", "AB44:AF44", "AH44:AN44", "J45:S45", "AB45:AF45",
    "J46:S46", "AB46:AF46", "AH46:AN46", "AH30:AN31",
]

# === SHARED STRINGS (индексы как в Excel t="s" v="N") ===
SHARED_STRINGS = [
    "Унифицированная форма № ТОРГ-12\nУтверждена постановлением Госкомстата России от 25.12.98 № 132",
    "Коды", "Форма по ОКУД", "по ОКПО",
    "организация-грузоотправитель, адрес, телефон, факс, банковские реквизиты",
    "структурное подразделение", "Вид деятельности по ОКДП", "Грузополучатель",
    "организация, адрес, телефон, факс, банковские реквизиты",
    "Поставщик", "Плательщик", "номер", "Основание", "договор, заказ-наряд",
    "дата", "Номер документа", "Дата составления", "Транспортная накладная",
    "ТОВАРНАЯ НАКЛАДНАЯ", "Вид операции", "Страница 1",
    "Номер\nпо порядку", "Товар", "Единица измерения", "Вид упаковки",
    "Количество", "Масса брутто", "Количество\n(масса нетто)",
    "Цена,\nруб. коп.", "Сумма без\nучета НДС,\nруб. коп.", "НДС",
    "Сумма с\nучетом НДС,\nруб. коп.",
    "наименование, характеристика, сорт, артикул товара", "код",
    "наименование", "код по ОКЕИ", "в одном месте", "мест,\nштук",
    "ставка, %", "сумма,\nруб. коп.", "Итого", "Х", "Всего по накладной",
    "Товарная накладная имеет приложение на", "и содержит",
    "порядковых номеров записей", "прописью", "Масса груза (нетто)",
    "Всего мест", "Масса груза (брутто)", "Приложение (паспорта, сертификаты и т.п.) на",
    "листах", "По доверенности №", "от", "Всего отпущено на сумму",
    "выданной", "кем, кому (организация, должность, фамилия, и. о.)",
    "Отпуск груза разрешил", "Генеральный директор", "должность", "подпись",
    "расшифровка подписи", "Главный (старший) бухгалтер", "Груз принял",
    "Отпуск груза произвел", "Груз получил", "грузополучатель", "М.П.",
    '"     " _____________ 20     года', '"  "', "20 года",
]

def col_letter_to_num(s):
    n = 0
    for c in s.upper():
        n = n * 26 + (ord(c) - ord('A') + 1)
    return n

def parse_cell_ref(ref):
    """A1 -> (row, col) 1-based"""
    m = re.match(r'([A-Z]+)(\d+)', ref, re.I)
    if m:
        return (int(m.group(2)), col_letter_to_num(m.group(1)))
    return (0, 0)

def parse_range(ref):
    """A1:B2 -> (r1, c1, r2, c2)"""
    if ':' in ref:
        a, b = ref.split(':')
        r1, c1 = parse_cell_ref(a)
        r2, c2 = parse_cell_ref(b)
        return (r1, c1, r2, c2)
    r, c = parse_cell_ref(ref)
    return (r, c, r, c)

# Конверсия в мм: 1 Excel width unit = 0.852 mm
# A4 landscape: 297mm, margins 10mm -> 277mm. Scale to fit.
EXCEL_TO_MM = 0.852
TOTAL_EXCEL_MM = sum(COL_WIDTHS_EXCEL[:39]) * EXCEL_TO_MM
PAGE_USABLE_MM = 277
SCALE = PAGE_USABLE_MM / TOTAL_EXCEL_MM if TOTAL_EXCEL_MM > 0 else 1.0

def col_width_mm(col_1based):
    """Ширина колонки в мм (масштабированная)"""
    idx = col_1based - 1
    if 0 <= idx < len(COL_WIDTHS_EXCEL):
        return COL_WIDTHS_EXCEL[idx] * EXCEL_TO_MM * SCALE
    return 5.0

def row_height_mm(row_1based):
    """Высота строки в мм (1 pt = 0.3528 mm)"""
    pt = ROW_HEIGHTS_PT.get(row_1based, DEFAULT_ROW_HEIGHT_PT)
    return pt * 0.3528
