{% if current_user.role != "–ú–æ–Ω–∏—Ç–æ—Ä" %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ó–∞–∫–∞–∑—ã</title>
  <style>
    /* üîß –°—Ç–∏–ª–∏ ‚Äî –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã */
    body {
      margin: 0;
      background: #f9f9f9;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      color: #333;
    }
    .top-bar {
      background: #fff;
      padding: 16px;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .form-box {
      background: #fff;
      margin: 20px;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }
    input, select, button {
      display: block;
      width: 100%;
      margin: 8px 0;
      padding: 10px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button {
      background: #4CAF50;
      color: #fff;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
    }
    button:hover {
      background: #45A049;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
    }
    button:active {
      transform: translateY(0);
      box-shadow: 0 1px 4px rgba(76, 175, 80, 0.3);
    }
    table {
      width: 95%;
      margin: 20px auto;
      background: #fff;
      border-collapse: collapse;
    }
    th, td {
      padding: 12px;
      border-bottom: 1px solid #eee;
      text-align: center;
      vertical-align: middle;
    }
    th {
      background-color: #f2f2f2;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 46px;
      height: 26px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      border-radius: 26px;
      transition: .3s ease-in-out;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      border-radius: 50%;
      transition: .3s ease-in-out;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    input:checked + .slider {
      background-color: #4CAF50;
      box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
    }
    input:checked + .slider:before {
      transform: translateX(20px);
    }
    .delete-icon {
      background: none;
      border: none;
      font-size: 18px;
      color: #e33;
      cursor: pointer;
    }
    .row-green { background-color: #d4edda !important; }
    .row-warning { background-color: #fff3cd !important; }
    .row-danger { background-color: #f8d7da !important; }
    .highlight-row {
      outline: 2px solid black;
      outline-offset: -2px;
      border-radius: 6px;
    }
    .tabs {
      display: flex;
      background: #fff;
      border-radius: 12px;
      padding: 4px;
      margin: 20px 20px 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      gap: 4px;
    }
    .tab {
      flex: 1;
      padding: 12px 20px;
      text-align: center;
      cursor: pointer;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s ease;
      background: #f2f2f2;
      color: #555;
      border: none;
      font-size: 15px;
    }
    .tab:hover { background: #e8e8e8; color: #333; }
    .tab.active { background: #757575; color: #fff; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15); }
    .tab-content { display: none; margin: 0 20px 20px; }
    .tab-content.active { display: block; }
    .customers-list {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      list-style: none;
      margin: 0;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 12px;
    }
    .customers-list li {
      padding: 12px 16px;
      background: #f9f9f9;
      border-radius: 8px;
      border: 1px solid #eee;
      font-size: 15px;
    }
    .btn-add-counterparty {
      background: #4CAF50;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      margin-bottom: 16px;
    }
    .btn-add-counterparty:hover { background: #45A049; }
    .counterparty-form-wrap {
      background: #f5f5f5;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 1px solid #ddd;
    }
    .counterparty-block {
      margin-bottom: 20px;
    }
    .counterparty-block h4 {
      margin: 0 0 12px 0;
      font-size: 16px;
      color: #333;
    }
    .counterparty-block input,
    .counterparty-block select {
      display: block;
      width: 100%;
      margin: 8px 0;
      padding: 10px;
      font-size: 15px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .counterparty-form-actions {
      margin-top: 16px;
      display: flex;
      gap: 12px;
    }
    .counterparty-form-actions button {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 15px;
      cursor: pointer;
      border: none;
    }
    .counterparty-form-actions button[type="submit"] { background: #4CAF50; color: #fff; }
    .counterparty-form-actions button[type="submit"]:hover { background: #45A049; }
    .counterparty-form-actions button[type="button"] { background: #4CAF50; color: #fff; }
    .counterparty-form-actions button[type="button"]:hover { background: #45A049; }
    .counterparty-link { text-decoration: none; color: #333; display: block; }
    .counterparty-link:hover { color: #1976D2; }
    .counterparty-link .cp-info { color: #666; font-weight: normal; }
    .pricelist-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 16px; }
    @media (max-width: 900px) { .pricelist-grid { grid-template-columns: 1fr; } }
    .pricelist-grid-cell { min-width: 0; }
    .pricelist-table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    .pricelist-table th, .pricelist-table td { padding: 10px 12px; text-align: left; border: 1px solid #ddd; }
    .pricelist-table th { background: #f5f5f5; font-weight: 600; }
    .pricelist-table tbody tr:nth-child(even) { background: #fafafa; }
    .pricelist-table tbody tr.dragging { opacity: 0.5; }
    .pricelist-table tbody tr.drag-over { border-top: 2px solid #4CAF50; }
    .pricelist-category-title { margin: 20px 0 8px 0; font-size: 17px; color: #333; }
    .pricelist-category-title:first-of-type { margin-top: 0; }
    .btn-edit-pricelist { padding: 6px 12px; font-size: 13px; cursor: pointer; background: #4CAF50; color: #fff; border: none; border-radius: 6px; }
    .btn-edit-pricelist:hover { background: #45A049; }
    .pricelist-drag-handle { cursor: grab; color: #999; padding: 0 6px; user-select: none; }
    .pricelist-drag-handle:active { cursor: grabbing; }
  </style>
</head>
<body>
  <div class="top-bar">
    {% if current_user.role == "–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ" %}
    <h2>üè≠ –†–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞</h2>
    {% elif current_user.role == "–ú–µ–Ω–µ–¥–∂–µ—Ä" %}
    <h2>üìã –ü–∞–Ω–µ–ª—å –∑–∞–∫–∞–∑–æ–≤</h2>
    {% else %}
    <h2>–ü–∞–Ω–µ–ª—å –∑–∞–∫–∞–∑–æ–≤</h2>
    {% endif %}
    <div>
      {{ current_user.username }} ({{ current_user.role }})
      {% if current_user.role in ["–ê–¥–º–∏–Ω", "–ú–µ–Ω–µ–¥–∂–µ—Ä", "–§—Ä–µ–∑–µ—Ä–æ–≤–∫–∞"] %}<a href="{{ url_for('settings') }}" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏" style="margin-left:8px; text-decoration:none; color:#666; font-size:18px;">‚öôÔ∏è</a>{% endif %}
      | <a href="{{ url_for('logout') }}">–í—ã—Ö–æ–¥</a>
    </div>
  </div>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div style="text-align:center; color: green;">
        {% for msg in messages %}
          <p>{{ msg }}</p>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  {% if current_user.role == "–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ" %}
  <div style="background: #e3f2fd; padding: 12px; margin: 20px; border-radius: 8px; border-left: 4px solid #2196f3;">
    <p style="margin: 0; color: #1976d2; font-weight: 500;">
      üìã –ü–æ–∫–∞–∑–∞–Ω—ã –∑–∞–∫–∞–∑—ã, –ø—Ä–æ—à–µ–¥—à–∏–µ —Ñ—Ä–µ–∑–µ—Ä–æ–≤–∫—É –∏ —à–ª–∏—Ñ–æ–≤–∫—É. –ü–æ—Å–ª–µ –æ—Ç–º–µ—Ç–∫–∏ —É–ø–∞–∫–æ–≤–∫–∏ –∏–ª–∏ –æ—Ç–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑ –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç—Å—è –≤ –∫–æ–Ω–µ—Ü —Å–ø–∏—Å–∫–∞.
    </p>
  </div>
  {% endif %}

  {% if current_user.role == "–ú–µ–Ω–µ–¥–∂–µ—Ä" %}
  {% set active_tab = request.args.get('tab', 'orders') %}
  <div class="tabs">
    <button type="button" class="tab {{ 'active' if active_tab == 'orders' else '' }}" onclick="showManagerTab('orders')">üìã –ü–∞–Ω–µ–ª—å –∑–∞–∫–∞–∑–æ–≤</button>
    <button type="button" class="tab {{ 'active' if active_tab == 'counterparties' else '' }}" onclick="showManagerTab('counterparties')">üë• –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã</button>
    <button type="button" class="tab {{ 'active' if active_tab == 'pricelist' else '' }}" onclick="showManagerTab('pricelist')">üí∞ –ü—Ä–∞–π—Å –ª–∏—Å—Ç</button>
  </div>
  <div id="manager-orders-tab" class="tab-content {{ 'active' if active_tab == 'orders' else '' }}">
  {% endif %}

  {% if current_user.role == "–ú–µ–Ω–µ–¥–∂–µ—Ä" %}
  <div class="form-box">
    <h3>–î–æ–±–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</h3>
    <form method="POST" enctype="multipart/form-data" id="add-order-form">
      <input type="text" name="order_id" placeholder="‚Ññ –∑–∞–∫–∞–∑–∞" required>
      <label for="client_name" style="display:block; margin-top:8px; font-weight:500;">–ö–ª–∏–µ–Ω—Ç</label>
      <input type="text" name="client" id="client_name" list="client_datalist" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞" required>
      <datalist id="client_datalist">
        {% for c in counterparties %}
        <option value="{{ c.name }}" data-id="{{ c.id }}">
        {% endfor %}
      </datalist>
      <input type="hidden" name="counterparty_id" id="counterparty_id" value="">
      <input type="number" name="days" placeholder="–°—Ä–æ–∫ (–≤ –¥–Ω—è—Ö)" required>
      <select name="facade_type" required>
        <option value="">‚Äî –¢–∏–ø —Ñ–∞—Å–∞–¥–∞ ‚Äî</option>
        <option value="—Ñ—Ä–µ–∑–µ—Ä–æ–≤–∞–Ω–Ω—ã–π">–§—Ä–µ–∑–µ—Ä–æ–≤–∞–Ω–Ω—ã–π</option>
        <option value="–ø–ª–æ—Å–∫–∏–π">–ü–ª–æ—Å–∫–∏–π</option>
        <option value="—à–ø–æ–Ω">–®–ø–æ–Ω</option>
      </select>
      <input type="number" name="area" placeholder="–ü–ª–æ—â–∞–¥—å (–º¬≤)" step="0.01" required>
      <input type="file" name="files" multiple>
      <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
    </form>
  </div>
  {% endif %}

  <div class="form-box" style="margin-top: 0;">
    <h3>–ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–æ–≤</h3>
    <form method="GET" action="{{ url_for('dashboard') }}">
      <input type="text" name="order_id_query" placeholder="–ü–æ–∏—Å–∫ –ø–æ ‚Ññ –∑–∞–∫–∞–∑–∞" value="{{ request.args.get('order_id_query', '') }}">
      <input type="text" name="client_query" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–ª–∏–µ–Ω—Ç—É" value="{{ request.args.get('client_query', '') }}">
      <button type="submit">–ù–∞–π—Ç–∏</button>
    </form>
  </div>

  <table>
    <tr>
      <th>‚Ññ</th><th>–ö–ª–∏–µ–Ω—Ç</th><th>–°—Ä–æ–∫</th>
      <th>–§—Ä–µ–∑–µ—Ä–æ–≤–∫–∞</th><th>–®–ª–∏—Ñ–æ–≤–∫–∞</th><th>–£–ø–∞–∫–æ–≤–∫–∞</th><th>–û—Ç–≥—Ä—É–∑–∫–∞</th><th>–û–ø–ª–∞—Ç–∞</th><th>–§–∞–π–ª—ã</th>
      {% if current_user.role == "–ú–µ–Ω–µ–¥–∂–µ—Ä" %}<th>–£–¥–∞–ª–∏—Ç—å</th>{% endif %}
    </tr>
    {% for o in orders %}
      {% set days_left = (o.due_date - datetime.utcnow().date()).days %}
      {% set base_class = "" %}
      {% if o.packaging %} {% set base_class = "row-green" %}
      {% elif days_left <= 3 %} {% set base_class = "row-danger" %}
      {% elif days_left <= 6 %} {% set base_class = "row-warning" %}
      {% endif %}
      {% set highlight_class = "" %}
      {% if request.args.get('order_id_query') == o.order_id or request.args.get('client_query') == o.client %}
        {% set highlight_class = "highlight-row" %}
      {% endif %}
      <tr data-order-id="{{ o.id }}" class="{{ base_class }} {% if highlight_class %}{{ highlight_class }}{% endif %}">
        <td>{{ o.order_id }}</td>
        <td>{% set cp_id = o.counterparty_id or cp_id_for_client.get(o.client) %}{% if cp_id %}<a href="{{ url_for('counterparty_card', counterparty_id=cp_id) }}" style="color:inherit;text-decoration:none;">{{ o.client }}</a>{% else %}{{ o.client }}{% endif %}</td>
        <td>{{ o.due_date.strftime('%Y-%m-%d') }}</td>
        {% if current_user.role in ["–ú–µ–Ω–µ–¥–∂–µ—Ä", "–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ"] %}
        <td><label class="switch"><input type="checkbox" name="milling" {% if o.milling %}checked{% endif %}><span class="slider"></span></label></td>
        <td><label class="switch"><input type="checkbox" name="polishing_1" {% if o.polishing_1 %}checked{% endif %}><span class="slider"></span></label></td>
        <td><label class="switch"><input type="checkbox" name="packaging" {% if o.packaging %}checked{% endif %}><span class="slider"></span></label></td>
        <td><label class="switch"><input type="checkbox" name="shipment" {% if o.shipment %}checked{% endif %}><span class="slider"></span></label></td>
        <td><label class="switch"><input type="checkbox" name="paid" {% if o.paid %}checked{% endif %}><span class="slider"></span></label></td>
        {% else %}
        <td>{{ "‚úî" if o.milling else "‚úñ" }}</td>
        <td>{{ "‚úî" if o.polishing_1 else "‚úñ" }}</td>
        <td>{{ "‚úî" if o.packaging else "‚úñ" }}</td>
        <td>{{ "‚úî" if o.shipment else "‚úñ" }}</td>
        <td>{{ "‚úî" if o.paid else "‚úñ" }}</td>
        {% endif %}
        <td>
          {% if o.filenames %}
            {% for fn in o.filenames.split(';') %}
              {% if fn %}
                <a href="{{ url_for('uploaded_file', filename=fn) }}" target="_blank">üìé {{ fn }}</a><br>
              {% endif %}
            {% endfor %}
          {% else %}
            ‚Äî
          {% endif %}
        </td>

        {% if current_user.role == "–ú–µ–Ω–µ–¥–∂–µ—Ä" %}
        <td>
          <button class="delete-icon" onclick="deleteOrder({{ o.id }})">üóëÔ∏è</button>
        </td>
        {% endif %}
      </tr>
    {% endfor %}
  </table>

  {% if current_user.role == "–ú–µ–Ω–µ–¥–∂–µ—Ä" %}
  </div>
  <div id="manager-counterparties-tab" class="tab-content {{ 'active' if active_tab == 'counterparties' else '' }}">
    <div class="form-box">
      <h3>üë• –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã</h3>
      <input type="text" id="counterparty-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, —Ç–µ–ª–µ—Ñ–æ–Ω—É –∏–ª–∏ email..." class="counterparty-search-input" style="width:100%; max-width:320px; margin-bottom:12px; padding:8px;">
      <button type="button" class="btn-add-counterparty" onclick="toggleCounterpartyForm()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞</button>
      <div id="counterparty-form-wrap" class="counterparty-form-wrap" style="display: none;">
        <form method="POST" action="{{ url_for('counterparty_add') }}" class="counterparty-form">
          <div class="counterparty-block">
            <h4>–û –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–µ</h4>
            <input type="text" name="counterparty_name" placeholder="–ò–º—è" required>
            <input type="text" name="counterparty_phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
            <input type="text" name="counterparty_email" placeholder="–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –∞–¥—Ä–µ—Å">
          </div>
          <div class="counterparty-block">
            <h4>–†–µ–∫–≤–∏–∑–∏—Ç—ã</h4>
            <select name="counterparty_type">
              <option value="">‚Äî –¢–∏–ø –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ ‚Äî</option>
              <option value="—é—Ä –ª–∏—Ü–æ">–Æ—Ä. –ª–∏—Ü–æ</option>
              <option value="—Ñ–∏–∑ –ª–∏—Ü–æ">–§–∏–∑. –ª–∏—Ü–æ</option>
            </select>
            <input type="text" name="counterparty_inn" placeholder="–ò–ù–ù">
            <input type="text" name="counterparty_full_name" placeholder="–ü–æ–ª–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ">
            <input type="text" name="counterparty_legal_address" placeholder="–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å">
            <input type="text" name="counterparty_fias_code" placeholder="–ö–æ–¥ –§–ò–ê–°">
            <input type="text" name="counterparty_kpp" placeholder="–ö–ü–ü">
            <input type="text" name="counterparty_ogrn" placeholder="–û–ì–†–ù">
            <input type="text" name="counterparty_okpo" placeholder="–û–ö–ü–û">
            <input type="text" name="counterparty_bik" placeholder="–ë–ò–ö">
            <input type="text" name="counterparty_bank" placeholder="–ë–∞–Ω–∫">
            <input type="text" name="counterparty_address" placeholder="–ê–¥—Ä–µ—Å">
            <input type="text" name="counterparty_corr_account" placeholder="–ö–æ—Ä—Ä. —Å—á—ë—Ç">
            <input type="text" name="counterparty_payment_account" placeholder="–†–∞—Å—á—ë—Ç–Ω—ã–π —Å—á—ë—Ç">
          </div>
          <div class="counterparty-form-actions">
            <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button type="button" onclick="toggleCounterpartyForm()">–û—Ç–º–µ–Ω–∞</button>
          </div>
        </form>
      </div>
      {% if counterparties %}
      <ul class="customers-list counterparties-list" id="counterparties-list">
        {% for c in counterparties %}
        <li class="counterparty-item" data-search="{{ (c.name or '')|lower }} {{ (c.phone or '')|lower }} {{ (c.email or '')|lower }}">
          <a href="{{ url_for('counterparty_card', counterparty_id=c.id) }}" class="counterparty-link">
            <strong>{{ c.name }}</strong>
            {% if c.phone %}<span class="cp-info"> ¬∑ {{ c.phone }}</span>{% endif %}
            {% if c.email %}<span class="cp-info"> ¬∑ {{ c.email }}</span>{% endif %}
          </a>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p style="color: #666; margin: 12px 0 0;">–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤. –ù–∞–∂–º–∏—Ç–µ ¬´–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞¬ª.</p>
      {% endif %}
    </div>
  </div>
  <div id="manager-pricelist-tab" class="tab-content {{ 'active' if active_tab == 'pricelist' else '' }}">
    <div class="form-box">
      <h3>üí∞ –ü—Ä–∞–π—Å –ª–∏—Å—Ç</h3>
      <input type="text" id="pricelist-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—é –∏–ª–∏ –µ–¥. –∏–∑–º...." style="width:100%; max-width:320px; margin-bottom:12px; padding:8px;">
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <button type="button" class="btn-add-counterparty" onclick="openPricelistFormForAdd()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é</button>
        <a href="{{ url_for('pricelist_export_pdf') }}" class="btn-add-counterparty" style="text-decoration:none; display:inline-flex; align-items:center; width:auto;">üìÑ –°–∫–∞—á–∞—Ç—å PDF</a>
      </div>
      <div id="pricelist-form-wrap" class="counterparty-form-wrap" style="display: none;">
        <form id="pricelist-form" method="POST" action="{{ url_for('pricelist_add') }}" class="counterparty-form">
          <div class="counterparty-block">
            <h4 id="pricelist-form-title">–ü–æ–∑–∏—Ü–∏—è –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–∞</h4>
            <select name="pricelist_category" id="pricelist_category">
              <option value="">‚Äî –ö–∞—Ç–µ–≥–æ—Ä–∏—è ‚Äî</option>
              <option value="–ø–ª–æ—Å–∫–∏–π">–ü–ª–æ—Å–∫–∏–µ</option>
              <option value="—Ñ—Ä–µ–∑–µ—Ä–æ–≤–∞–Ω–Ω—ã–π">–§—Ä–µ–∑–µ—Ä–æ–≤–∞–Ω–Ω—ã–µ</option>
              <option value="—à–ø–æ–Ω">–®–ø–æ–Ω</option>
              <option value="—É—Å–ª—É–≥–∏ –ø–æ –ø–æ–∫—Ä–∞—Å–∫–µ">–£—Å–ª—É–≥–∏ –ø–æ –ø–æ–∫—Ä–∞—Å–∫–µ</option>
              <option value="–î–æ–ø —É—Å–ª—É–≥–∏">–î–æ–ø —É—Å–ª—É–≥–∏</option>
            </select>
            <input type="text" name="pricelist_name" id="pricelist_name" placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ" required>
            <input type="number" name="pricelist_price" id="pricelist_price" placeholder="–¶–µ–Ω–∞ (—Ä—É–±.)" step="0.01" min="0" required>
            <input type="text" name="pricelist_unit" id="pricelist_unit" placeholder="–ï–¥. –∏–∑–º. (—à—Ç, –º¬≤, –ø.–º.)">
          </div>
          <div class="counterparty-form-actions">
            <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button type="button" onclick="togglePricelistForm()">–û—Ç–º–µ–Ω–∞</button>
          </div>
        </form>
      </div>
      {% if price_list %}
      {% set grid_cats = [('–ø–ª–æ—Å–∫–∏–π', '–ü–ª–æ—Å–∫–∏–µ'), ('—Ñ—Ä–µ–∑–µ—Ä–æ–≤–∞–Ω–Ω—ã–π', '–§—Ä–µ–∑–µ—Ä–æ–≤–∞–Ω–Ω—ã–µ'), ('—à–ø–æ–Ω', '–®–ø–æ–Ω'), ('—É—Å–ª—É–≥–∏ –ø–æ –ø–æ–∫—Ä–∞—Å–∫–µ', '–£—Å–ª—É–≥–∏ –ø–æ –ø–æ–∫—Ä–∞—Å–∫–µ'), ('–î–æ–ø —É—Å–ª—É–≥–∏', '–î–æ–ø —É—Å–ª—É–≥–∏')] %}
      {% set other_items = price_list|selectattr('category', 'none')|list %}
      <div id="pricelist-list" class="pricelist-grid">
      {% for cat, label in grid_cats %}
      {% set cat_items = price_list|selectattr('category', 'equalto', cat)|list %}
      <div class="pricelist-grid-cell">
      <h4 class="pricelist-category-title">{{ label }}</h4>
      {% if cat_items %}
      <table class="pricelist-table pricelist-list" data-category="{{ cat }}">
        <thead>
          <tr><th style="width:28px;"></th><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th><th>–¶–µ–Ω–∞, ‚ÇΩ</th><th>–ï–¥. –∏–∑–º.</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr>
        </thead>
        <tbody>
        {% for p in cat_items %}
        <tr class="pricelist-item" draggable="true" data-search="{{ (p.name or '')|lower }} {{ (p.unit or '')|lower }}" data-id="{{ p.id }}" data-name="{{ p.name|e }}" data-price="{{ p.price }}" data-unit="{{ p.unit or '' }}" data-category="{{ p.category or '' }}" ondragstart="pricelistDragStart(event)" ondragover="pricelistDragOver(event)" ondragleave="pricelistDragLeave(event)" ondrop="pricelistDrop(event)" ondragend="pricelistDragEnd(event)">
          <td><span class="pricelist-drag-handle" title="–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞">‚ãÆ‚ãÆ</span></td>
          <td>{{ p.name }}</td>
          <td>{{ (p.price|round(2))|string|replace(".", ",") }}</td>
          <td>{{ p.unit or '‚Äî' }}</td>
          <td><button type="button" class="btn-edit-pricelist" onclick="editPricelistRow(this)">–ò–∑–º–µ–Ω–∏—Ç—å</button></td>
        </tr>
        {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p style="color:#999; font-size:14px; margin:8px 0;">–ù–µ—Ç –ø–æ–∑–∏—Ü–∏–π</p>
      {% endif %}
      </div>
      {% endfor %}
      <div class="pricelist-grid-cell">
      <h4 class="pricelist-category-title">–ü—Ä–æ—á–µ–µ</h4>
      {% if other_items %}
      <table class="pricelist-table pricelist-list" data-category="">
        <thead>
          <tr><th style="width:28px;"></th><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th><th>–¶–µ–Ω–∞, ‚ÇΩ</th><th>–ï–¥. –∏–∑–º.</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr>
        </thead>
        <tbody>
        {% for p in other_items %}
        <tr class="pricelist-item" draggable="true" data-search="{{ (p.name or '')|lower }} {{ (p.unit or '')|lower }}" data-id="{{ p.id }}" data-name="{{ p.name|e }}" data-price="{{ p.price }}" data-unit="{{ p.unit or '' }}" data-category="" ondragstart="pricelistDragStart(event)" ondragover="pricelistDragOver(event)" ondragleave="pricelistDragLeave(event)" ondrop="pricelistDrop(event)" ondragend="pricelistDragEnd(event)">
          <td><span class="pricelist-drag-handle" title="–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞">‚ãÆ‚ãÆ</span></td>
          <td>{{ p.name }}</td>
          <td>{{ (p.price|round(2))|string|replace(".", ",") }}</td>
          <td>{{ p.unit or '‚Äî' }}</td>
          <td><button type="button" class="btn-edit-pricelist" onclick="editPricelistRow(this)">–ò–∑–º–µ–Ω–∏—Ç—å</button></td>
        </tr>
        {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p style="color:#999; font-size:14px; margin:8px 0;">–ù–µ—Ç –ø–æ–∑–∏—Ü–∏–π</p>
      {% endif %}
      </div>
      </div>
      {% else %}
      <p style="color: #666; margin: 12px 0 0;">–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ–∑–∏—Ü–∏–π. –ù–∞–∂–º–∏—Ç–µ ¬´–î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é¬ª.</p>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <script>
    {% if current_user.role == "–ú–µ–Ω–µ–¥–∂–µ—Ä" %}
    function showManagerTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(function(el) {
        el.classList.remove('active');
      });
      document.querySelectorAll('.tabs .tab').forEach(function(el) {
        el.classList.remove('active');
      });
      var tabEl = document.getElementById('manager-' + tabName + '-tab');
      if (tabEl) tabEl.classList.add('active');
      event.target.classList.add('active');
    }
    function toggleCounterpartyForm() {
      var wrap = document.getElementById('counterparty-form-wrap');
      if (wrap) wrap.style.display = wrap.style.display === 'none' ? 'block' : 'none';
    }
    function togglePricelistForm() {
      var wrap = document.getElementById('pricelist-form-wrap');
      if (wrap) wrap.style.display = wrap.style.display === 'none' ? 'block' : 'none';
    }
    function openPricelistFormForAdd() {
      var form = document.getElementById('pricelist-form');
      var titleEl = document.getElementById('pricelist-form-title');
      if (form) {
        form.action = "{{ url_for('pricelist_add') }}";
        var catInp = document.getElementById('pricelist_category');
        var nameInp = document.getElementById('pricelist_name');
        var priceInp = document.getElementById('pricelist_price');
        var unitInp = document.getElementById('pricelist_unit');
        if (catInp) catInp.value = '';
        if (nameInp) nameInp.value = '';
        if (priceInp) priceInp.value = '';
        if (unitInp) unitInp.value = '';
      }
      if (titleEl) titleEl.textContent = '–ü–æ–∑–∏—Ü–∏—è –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–∞';
      togglePricelistForm();
    }
    function editPricelistRow(btn) {
      var tr = btn.closest('tr');
      if (!tr) return;
      var id = tr.getAttribute('data-id');
      var name = tr.getAttribute('data-name') || '';
      var price = tr.getAttribute('data-price') || '';
      var unit = tr.getAttribute('data-unit') || '';
      var category = tr.getAttribute('data-category') || '';
      var form = document.getElementById('pricelist-form');
      var titleEl = document.getElementById('pricelist-form-title');
      if (form && id) {
        form.action = "{{ url_for('pricelist_edit', item_id=0) }}".replace('0', id);
        var catInp = document.getElementById('pricelist_category');
        var nameInp = document.getElementById('pricelist_name');
        var priceInp = document.getElementById('pricelist_price');
        var unitInp = document.getElementById('pricelist_unit');
        if (catInp) catInp.value = category;
        if (nameInp) nameInp.value = name;
        if (priceInp) priceInp.value = price;
        if (unitInp) unitInp.value = unit;
      }
      if (titleEl) titleEl.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é';
      togglePricelistForm();
    }
    var pricelistDraggedRow = null;
    function pricelistDragStart(ev) {
      pricelistDraggedRow = ev.target.closest('tr');
      if (pricelistDraggedRow) {
        pricelistDraggedRow.classList.add('dragging');
        ev.dataTransfer.effectAllowed = 'move';
        ev.dataTransfer.setData('text/plain', pricelistDraggedRow.getAttribute('data-id'));
      }
    }
    function pricelistDragOver(ev) {
      ev.preventDefault();
      var row = ev.target.closest('tr.pricelist-item');
      if (!row || row === pricelistDraggedRow) return;
      var tbody = row.closest('tbody');
      if (pricelistDraggedRow && tbody && tbody.contains(pricelistDraggedRow)) {
        ev.dataTransfer.dropEffect = 'move';
        row.classList.add('drag-over');
      }
    }
    function pricelistDragLeave(ev) {
      var row = ev.target.closest('tr.pricelist-item');
      if (row) row.classList.remove('drag-over');
    }
    function pricelistDrop(ev) {
      ev.preventDefault();
      var dropRow = ev.target.closest('tr.pricelist-item');
      if (!dropRow || !pricelistDraggedRow || dropRow === pricelistDraggedRow) return;
      var tbody = dropRow.closest('tbody');
      if (!tbody || !tbody.contains(pricelistDraggedRow)) return;
      dropRow.classList.remove('drag-over');
      tbody.insertBefore(pricelistDraggedRow, dropRow);
      var ids = [];
      tbody.querySelectorAll('tr.pricelist-item').forEach(function(r) { ids.push(parseInt(r.getAttribute('data-id'), 10)); });
      fetch("{{ url_for('pricelist_reorder') }}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ item_ids: ids })
      }).then(function(r) {
        if (!r.ok) console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫');
      });
    }
    function pricelistDragEnd(ev) {
      if (pricelistDraggedRow) pricelistDraggedRow.classList.remove('dragging');
      pricelistDraggedRow = null;
      document.querySelectorAll('.pricelist-item.drag-over').forEach(function(r) { r.classList.remove('drag-over'); });
    }
    (function() {
      var clientName = document.getElementById('client_name');
      var counterpartyId = document.getElementById('counterparty_id');
      var nameToId = {};
      try {
        var arr = {{ counterparties_json|tojson }};
        if (Array.isArray(arr)) arr.forEach(function(c) { nameToId[c.name] = c.id; });
      } catch (e) {}
      if (clientName && counterpartyId) {
        function syncCounterpartyId() {
          var v = clientName.value.trim();
          counterpartyId.value = (nameToId[v] !== undefined) ? String(nameToId[v]) : '';
        }
        clientName.addEventListener('input', syncCounterpartyId);
        clientName.addEventListener('change', syncCounterpartyId);
      }
    })();
    (function() {
      var searchInput = document.getElementById('counterparty-search');
      var list = document.getElementById('counterparties-list');
      if (searchInput && list) {
        searchInput.addEventListener('input', function() {
          var q = this.value.trim().toLowerCase();
          list.querySelectorAll('.counterparty-item').forEach(function(li) {
            var show = !q || (li.getAttribute('data-search') || '').indexOf(q) !== -1;
            li.style.display = show ? '' : 'none';
          });
        });
      }
    })();
    (function() {
      var searchInput = document.getElementById('pricelist-search');
      var list = document.getElementById('pricelist-list');
      if (searchInput && list) {
        searchInput.addEventListener('input', function() {
          var q = this.value.trim().toLowerCase();
          list.querySelectorAll('.pricelist-item').forEach(function(li) {
            var show = !q || (li.getAttribute('data-search') || '').indexOf(q) !== -1;
            li.style.display = show ? '' : 'none';
          });
        });
      }
    })();
    {% endif %}
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
      cb.addEventListener('change', () => {
        const row = cb.closest('tr');
        const orderId = row.getAttribute('data-order-id');

        const milling = row.querySelector('input[name="milling"]')?.checked ? 1 : 0;
        const polishing_1 = row.querySelector('input[name="polishing_1"]')?.checked ? 1 : 0;
        const packaging = row.querySelector('input[name="packaging"]')?.checked ? 1 : 0;
        const shipment = row.querySelector('input[name="shipment"]')?.checked ? 1 : 0;
        const paid = row.querySelector('input[name="paid"]')?.checked ? 1 : 0;

        fetch(`/update_status/${orderId}`, {
          method: 'POST',
          headers: {'Content-Type': 'application/x-www-form-urlencoded'},
          body: new URLSearchParams({ milling, polishing_1, packaging, shipment, paid })
        }).then(res => {
          if (res.ok) {
            console.log("‚úîÔ∏è –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
            if (cb.name === "packaging") {
              row.classList.remove("row-green", "row-warning", "row-danger");
              const dueText = row.children[2]?.textContent;
              const dueDate = dueText ? new Date(dueText) : null;
              const today = new Date();
              if (!cb.checked && dueDate) {
                const daysLeft = Math.floor((dueDate - today) / (1000 * 60 * 60 * 24));
                if (daysLeft <= 3) {
                  row.classList.add("row-danger");
                } else if (daysLeft <= 6) {
                  row.classList.add("row-warning");
                }
              } else if (cb.checked) {
                row.classList.add("row-green");
              }
            }
            
            // –î–ª—è —Ä–æ–ª–∏ "–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ" –ø–µ—Ä–µ–º–µ—â–∞–µ–º –∑–∞–∫–∞–∑ –≤ –∫–æ–Ω–µ—Ü –ø–æ—Å–ª–µ –æ—Ç–º–µ—Ç–∫–∏ —É–ø–∞–∫–æ–≤–∫–∏ –∏–ª–∏ –æ—Ç–≥—Ä—É–∑–∫–∏
            {% if current_user.role == "–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ" %}
            if (cb.name === "packaging" || cb.name === "shipment") {
              if (cb.checked) {
                // –ü–µ—Ä–µ–º–µ—â–∞–µ–º —Å—Ç—Ä–æ–∫—É –≤ –∫–æ–Ω–µ—Ü —Ç–∞–±–ª–∏—Ü—ã
                const table = row.closest('table');
                const tbody = table.querySelector('tbody') || table;
                tbody.appendChild(row);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
                row.style.transition = 'all 0.5s ease';
                row.style.transform = 'translateX(100%)';
                setTimeout(() => {
                  row.style.transform = 'translateX(0)';
                }, 100);
              }
            }
            {% endif %}
          } else {
            alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏");
          }
        });
      });
    });
    
    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞
    function deleteOrder(orderId) {
      if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑?')) {
        fetch(`/delete_order/${orderId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert(data.message);
            location.reload();
          } else {
            alert('–û—à–∏–±–∫–∞: ' + data.message);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞');
        });
      }
    }
  </script>
</body>
</html>
{% else %}
<script>window.location.href = "/monitor";</script>
{% endif %}
