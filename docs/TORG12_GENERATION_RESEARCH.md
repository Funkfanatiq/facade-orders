# Генерация ТОРГ-12: исследование и решение

## Как делают бухгалтерские программы

### 1С:Предприятие
- **Макет (табличный документ)** — шаблон с областями: шапка, строки товаров, подвал
- **Области печати** — выводятся методом `Вывести()`/`Присоединить()` с параметрами
- **Повторяющиеся области** — для табличной части (каждая позиция = одна область)
- Не ручная расстановка координат — **таблица сама рассчитывает границы ячеек**

### Адаптивная печатная форма (ocvita.ru, 1С 8.2)
Ключевые идеи:
- **Макет с нуля** — не на основе типового
- **Увеличение полезной площади** — до 14 позиций на странице вместо 3–4
- **Ширина колонок по данным** — ширина поля «наименование» ~2× больше типового
- **Верхнее поле 10 мм** — для дырокола
- **Arial 8 pt** — основной шрифт
- **Адаптивное форматирование** — если все количества с 1 знаком после запятой, используется этот формат

### Онлайн-генераторы (u-crm.ru и др.)
- Используют табличную разметку
- PDF через серверный рендер (часто HTML→PDF или табличные библиотеки)

---

## Рекомендуемое решение для Python/ReportLab

### Проблема Canvas-подхода
Ручная расстановка `drawString(x, y, text)` приводит к:
- смещениям при масштабировании
- наложению текста
- сложности поддержки

### Решение: **Platypus Table** вместо Canvas

ReportLab **Table** (Platypus) сама:
1. Вычисляет границы ячеек
2. Переносит текст в ячейках
3. Управляет `colWidths` и `rowHeights`
4. Поддерживает `repeatRows=2` для заголовков на каждой странице
5. Корректно разбивает длинные таблицы по страницам

### Структура формы

```
1. Table: заголовок (форма, утверждение)
2. Table: верхний блок (грузоотправитель, грузополучатель, поставщик, плательщик, основание) + коды
3. Table: ТОВАРНАЯ НАКЛАДНАЯ + номер/дата
4. Table: товары — colWidths из GOODS_TABLE_COLS_MM, repeatRows=2
5. Paragraph/Table: нижняя часть (приложение, масса, всего отпущено)
6. Table: подписи
```

### Размеры
- **Поля**: 10 мм со всех сторон (как в адаптивной форме)
- **Колонки**: из `torg12_excel_dims.GOODS_TABLE_COLS_MM` (уже масштабированы под A4)
- **Высоты строк**: из `ROW_HEIGHTS_MM` или фиксированные ~4 mm для данных

### Пример кода (таблица товаров)

```python
from reportlab.platypus import Table, TableStyle
from reportlab.lib import colors

col_widths = [w * mm for w in GOODS_TABLE_COLS_MM]
data = [header_row1, header_row2]
for item in invoice.items:
    data.append([str(i), name, code, unit, okei, ..., qty, price, sum_val, "0%", sum_val])
data.append(total_row)

t = Table(data, colWidths=col_widths, repeatRows=2)
t.setStyle(TableStyle([
    ("GRID", (0,0), (-1,-1), 0.5, colors.black),
    ("FONTNAME", (0,0), (-1,-1), "Helvetica"),
    ("FONTSIZE", (0,0), (-1,-1), 7),
    ("VALIGN", (0,0), (-1,-1), "MIDDLE"),
]))
```

### Важно
- **Одна Table на секцию** — не пытаться нарисовать всю форму одной таблицей
- **SPAN** для объединённых ячеек в шапке
- **Paragraph** внутри ячеек для длинного текста (наименование, адреса)

---

## Вывод

Перейти с **Canvas** (ручные координаты) на **Platypus Table** — так делают 1С и типовые бухгалтерские системы. Таблица сама обеспечивает выравнивание, сетку и переносы.
